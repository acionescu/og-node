<html>
<head>

<meta charset="UTF-8">

<title>Open Groups - Anonymous chat</title>

<script src="js/app.js"></script>
<script src="js/event-bus.js"></script>
<script src="js/status-app.js"></script>
<script src="../tp/jquery-2.1.1.js"></script>

<link rel="stylesheet" href="../css/chat.css?v=16">
<meta name="viewport" content="width=device-width,initial-scale=1">

<script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function() {
	// Remove elements with "noscript" class - <noscript> is not allowed in XHTML
	var noscripts = document.getElementsByClassName("noscript");
	for (var i = 0; i < noscripts.length; i++) {
	    noscripts[i].parentNode.removeChild(noscripts[i]);
	}
    }, false);

    $(document).ready(function() {
	updateTarget("/og-node/ws/v0/events");
	setConnected(false);
    });

    var wse = null;

    var lastColor = "#eeeeee";

    var peers = {

    }

    var nodeModel;
    
    var reconnectId;
    
    var reconnectDelay = 5000;

    function updateTarget(target) {
	if (window.location.protocol == 'http:') {
	    document.getElementById('target').value = 'ws://'
		    + window.location.host + target;
	} else {
	    document.getElementById('target').value = 'wss://'
		    + window.location.host + target;
	}
    }

    function setConnected(connected) {

    }

    function setVisible(id, visible) {
	var elem = document.getElementById(id);
	if (visible) {
	    $(elem).show();
	} else {
	    $(elem).hide();
	}
    }

    function connect() {
	var target = document.getElementById('target').value;
	if (target == '') {
	    alert('Please select server side connection implementation.');
	    return;
	}
	log("connecting...")
	reconnectId=null;
	var wshandler = {
	    onopen : function() {
		setConnected(true);
		log('Info: WebSocket connection opened.');
		clearTimeout(reconnectId);
		reconnectId = null;
	    },
	    onmessage : function(event) {
		log('Received: ' + event.data);
	    },
	    onclose : function(event) {
		setConnected(false);
		var msg = 'WebSocket connection closed, Code: '
			+ event.code
			+ (event.reason == "" ? "" : ", Reason: "
				+ event.reason);
		log(msg);
		$("#infoCont").text(msg).show();
		$("#peers-data").empty();
		
// 		if(!(event.code==1001)){
			/* reconnect if the user din't close on purpose*/
			reconnect();
// 		}
	    }
	};

	wse = new StatusAppClient(target, true, wshandler, appState);

    }

    function disconnect() {
	wse.close();
	setConnected(false);
    }

    function joinChat() {
	if (wse) {
	    sendJoinChatRequest();
	} else {
	    connect();
	}
    }
    
    function reconnect(){
	if(reconnectId != null){
	    /* already in the process of reconnecting */
	    return;
	}
	$("#infoCont").text("Reconnecting...").show();
	reconnectId = setTimeout(function(){
	    connect();
	},reconnectDelay);
    }

    function sendJoinChatRequest() {
	var chatKey = $("#chatKey").val();
	wse.joinChat(chatKey);
    }

    function initNode(event) {
	nodeModel = event.data.model;

    }

    function initChat(event) {
	$("#connect-container").hide();
	$("#chat-container").show();
	$("#peers-data").empty();

	var ourChatData;
	/* reset last color */
	lastColor = "#eeeeee";
	
	/* reset chat participants */
	peers={};

	if (event.data.participants) {
	    event.data.participants.forEach(function(p) {
		if (p.peerId != nodeModel.clientId) {
		    addChatParticipant(p);
		} else {
		    ourChatData = p;
		}
	    });
	}

	$("#infoCont").empty();

	/* get our alias */

	var ourAlias;

	if (ourChatData != null) {
	    ourAlias = getShortAlias(ourChatData.alias);
	} else {
	    ourAlias = getShortAlias(nodeModel.clientId);
	}

	$("#infoCont").append($("<label>").text("Connected as ")).append(
		$("<div>").text(ourAlias).addClass("peer-id"));

    }

    function addChatParticipant(p) {

	/* generate a color for this peer */
	lastColor = generateColors(parseInt(lastColor.substring(1), 16),
		30303040, 1)[0];

	var pContext = {
	    color : lastColor,
	    data : p,
	    shortAlias : getShortAlias(p.alias),
	    settings: {}
	}

	peers[p.peerId] = pContext;

// 	$("#peers-data")
// 		.append(
// 			$("<div>").attr("id", p.peerId).text(
// 				pContext.shortAlias).addClass("peer-id").css(
// 				'background-color', lastColor));
	
	var peerInfo = getPeerInfoElem(pContext.shortAlias, p.peerId,{color:lastColor});
	peerInfo.attr("id",p.peerId);
	$("#peers-data").append(peerInfo);
    }

    function removeChatParticipant(peerId) {
	$("#peers-data").find("#" + escapeSelector(peerId)).remove();

	delete peers[peerId];
    }

    function escapeSelector(myid) {
	return myid.replace(/(:|\.|\[|\]|,|=|@)/g, "\\$1");
    }

    function addChatMessage(message, from) {
	var alias;
	if (from == wse.remoteId) {
	    alias = "Me: ";
	}
	appendChatMessage(message, alias, from);
	autoscroll("messages-area");

    }

    function appendChatMessage(message, alias, from) {
	var pContext = peers[from];
	
	if(pContext != null && pContext.settings["mutedPeer"]){
	    log("ignoring message from "+from+". Peer is muted.");
	    return;
	}
	
	var msgArea = $("#messages-area");

	var msgCont = $("<div>").addClass("msg-cont");

	var na = $("<div>").addClass("sender-name-area");
	var ta = $("<div>").addClass("msg-text-area");

	var color = "#aaaaaa";

	if (pContext) {
	    color = pContext.color;
	    if (alias == null) {
		alias = pContext.shortAlias;
	    }
	}
	if (alias == null) {
	    alias = getShortAlias(from);
	}

	var peerInfo = getPeerInfoElem(alias,from, {color:color});
	
	na.append(peerInfo);

	var msgText = $("<div>").text(message).addClass("msg-text");
	var msgMask=$("<div>").addClass("msg-mask").css("background",color).text(message);
	
	var msgDiv = $("<div>").addClass("msg-div");
	msgDiv.append(msgText);
	msgDiv.append(msgMask);
	
	ta.append(msgDiv);

	msgCont.append(na);
	msgCont.append(ta);

	msgArea.append(msgCont);
    }
    
    function getPeerInfoElem(alias, peerId, options){
	var peerInfoCont = $("#peerInfoTemp").clone();
	/* set alis as class */
	peerInfoCont.addClass(alias);
	/* reset id */
	peerInfoCont.attr("id","");
	
	var peerIdElem = peerInfoCont.find(".peerIdElem");
	peerIdElem.text(alias).addClass("peer-id").css(
		'background-color', options.color);
	
	var mutedCk = peerInfoCont.find(".mutedPeer");
	log("add change list "+mutedCk.length);
	mutedCk.change(function(e) {
	    	  var mutedVal = mutedCk.prop("checked");
		    log("blacklist peer " + peerId + " "
			    + mutedVal);
		    peers[peerId].settings["mutedPeer"]=mutedVal;
		    if(mutedVal){
			$("#"+peerId+" .peerState").css("background","black").attr("title","is muted").show();
		    }
		    else{
			$("#"+peerId+" .peerState").hide();
		    }
		});
	peerIdElem.off('click');
	peerIdElem.click(function(e){
	    /* don't display menu if we're clicking on our id */
	    if(peerId == nodeModel.clientId){
		return;
	    }
	    
	    var pc = peerInfoCont.find(".peerControls");
	    if(pc.css("display")=='none'){
		if(peers[peerId] == null){
		    /* has left */
		    var peerNotif = peerInfoCont.find(".peerNotif");
		    peerNotif.text("has left");
		    peerNotif.removeClass("notif");
		    void peerNotif[0].offsetWidth;
		    peerNotif.addClass("notif");
		    return;
		    
		}
		
		
		populatePeerControls(peerId,pc);
		/* hide all peer controls before opening this one */
		$(".peerControls").hide();
		pc.css("z-index",99);
		pc.css("display","inline-block");
		
		
	    }
	    else{
		pc.hide();
	    }
	});
	
	peerInfoCont.find(".peerControls").hide();
	peerInfoCont.show();
	return peerInfoCont;
    }
    
    function populatePeerControls(peerId, controls){
	var pContext = peers[peerId];
	var settings = pContext.settings;
	if(settings == null){
	    pContext.settings={};
	    return;
	}
	
	for(var s in settings){
	    controls.find("."+s).prop('checked',settings[s]);
	    log("setting control "+s +" to "+settings[s]);
	}
    }

    function getShortAlias(alias) {
	if (alias != null) {
	    return alias.substring(0, 10);
	}
	return "N/A";
    }

    function sendMessage() {
	var chatKey = $("#chatKey").val();
	var message = $("#msg").val();

	if (message.trim() != "") {
	    addChatMessage(message, wse.remoteId);

	    wse.sendChatMessage(chatKey, message);
	}
	$("#msg").val('');
    }

    function onKeyPress(event) {

	var key = event.keyCode;
	// If the user has pressed enter
	if (key == 13) {
	    sendMessage();
	    return false;
	} else {
	    return true;
	}
    }

    function autoscroll(elemId) {
	var objDiv = document.getElementById(elemId);
	objDiv.scrollTop = objDiv.scrollHeight;
    }

    function generateColors(startCol, step, count) {
	var out = [];
	var nextColor = startCol;

	for (var i = 0; i < count; i++) {
	    nextColor += step;
	    color = '#' + ('00000' + (nextColor | 0).toString(16)).substr(-6);
	    out.push(color);
	}

	return out;
    }

    function showHidePeers() {
	console.log($("#peersButton").text());
	if ($("#peers-area").css('display') == 'none'
		|| $("#peers-area").css("visibility") == "hidden") {
	    $("#peers-area").show();
	    $("#chat-area").removeClass("chat-fullscreen");
	    $("#peersButton").removeClass("closed").addClass("open");
	} else {
	    $("#peers-area").hide();
	    $("#chat-area").addClass("chat-fullscreen");
	    $("#peersButton").removeClass("open").addClass("closed");
	}
    }

    var appState = new WsState("APP_STATE", {

	/* now we can init */
	"STATUS-APP:PEER:INIT" : function(ec) {
	    initNode(ec.event);
	    sendJoinChatRequest();
	},

	"PEER:CHAT:INIT" : function(ec) {
	    initChat(ec.event);
	},

	"PEER:CHAT:JOINED" : function(ec) {
	    addChatParticipant(ec.event.data);
	},

	"PEER:CHAT:LEFT" : function(ec) {
	    removeChatParticipant(ec.event.data.peerId);
	},

	"PEER:CHAT:MESSAGE" : function(ec) {
	    addChatMessage(ec.event.data.message, ec.event.header.from);
	}
    });
</script>

</head>
<body>



	<div id="main-container">
		<div class="noscript">
			<h2 style="color: #ff0000">Seems your browser doesn't support
				Javascript! Websockets rely on Javascript being enabled. Please
				enable Javascript and reload this page!</h2>
		</div>

		<div id="connect-container">
			<div style="margin-top: 20px; color: #aaaaaa; font-size: 1.2em;">
				Chat anonymously</div>

			<div
				style="position: fixed; top: 20%; width: 100%; margin: 20px auto;">
				<h3>
					<label>Enter chat key:</label>
				</h3>
				<div>
					<input id="target" type="text"
						style="max-width: 330px; width: 20%;" hidden="true" /> <input
						id="chatKey" type="text" style="font-size: 1.2em;" />
					<button onclick="joinChat()"
						style="margin: 20px; margin-bottom: 50px; font-size: 1.2em;"
						class="button">Join</button>
				</div>
				<div style="margin: 10px; color: #aaaaaa; font-size: large;">
					Enter the secret key, shared with your partner/group, and start
					chatting.
					<p>Leave it empty to join the public chat.</p>
				</div>
			</div>

			<div
				style="margin: 10px auto; font-size: 1em; margin-top: 50px; position: absolute; bottom: 0; text-align: center; width: 100%;">
				<a href="https://github.com/acionescu/fruit-fly">Fork me</a>
			</div>

		</div>

		<div id="chat-container" style="display: none;">
			<div id="peers-area">
				<label for="peers-data">Chatting with:</label>
				<div id="peers-data"></div>
			</div>
			<div id="chat-area">
				<div id="chatHeader">
					<button id="peersButton" class="stateButton state"
						onclick="showHidePeers()"></button>
					<!-- 			<button id="peersButton" class="stateButton closed" onclick="showHidePeers()"></button>  -->
					<div id="infoCont"></div>

				</div>
				<div id="messages-area"></div>
				<div id="text-area">
					
					<div id="send-button-cont">
						<button id="send-button" class="button" onclick="sendMessage()">&gt;</button>
					</div>
					<div id="text-cont">
						<textarea id="msg" onkeypress="onKeyPress(event)"></textarea>
					</div>

				</div>

			</div>


		</div>
	</div>
	<div hidden id="peerInfoTemp" class="peerInfo">
		<div class="peerIdElem">peerId</div>
		<ul class="peerControls" hidden>
			<li><input type="checkbox" name="blacklist" class="mutedPeer">
			<label for="blacklist">Muted</label></li>
		</ul>
		<div class="peerNotif" hidden></div>
		<div class="peerState" hidden></div>
	</div>
</body>

</html>